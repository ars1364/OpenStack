---
# GitHub Actions self-hosted runner installation.
# If the runner tarball can't be downloaded (geo-restricted),
# pre-stage it at /tmp/actions-runner-<version>.tar.gz via SCP.

- name: Create runner directory
  ansible.builtin.file:
    path: /data/actions-runner
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: "0755"

- name: Create runner work directory
  ansible.builtin.file:
    path: "{{ github_runner_work_dir }}"
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: "0755"

- name: Check if runner is already installed
  ansible.builtin.stat:
    path: /data/actions-runner/config.sh
  register: runner_config

- name: Check for pre-staged runner tarball
  ansible.builtin.stat:
    path: "/tmp/actions-runner-{{ github_runner_version }}.tar.gz"
  register: prestaged_runner

- name: Download GitHub Actions runner
  ansible.builtin.get_url:
    url: "https://github.com/actions/runner/releases/download/v{{ github_runner_version }}/actions-runner-linux-x64-{{ github_runner_version }}.tar.gz"
    dest: "/tmp/actions-runner-{{ github_runner_version }}.tar.gz"
    mode: "0644"
    timeout: 30
  when: not runner_config.stat.exists and not prestaged_runner.stat.exists
  ignore_errors: true

- name: Extract runner
  ansible.builtin.unarchive:
    src: "/tmp/actions-runner-{{ github_runner_version }}.tar.gz"
    dest: /data/actions-runner
    remote_src: yes
    owner: ubuntu
    group: ubuntu
  when: not runner_config.stat.exists

- name: Install runner dependencies
  ansible.builtin.command: /data/actions-runner/bin/installdependencies.sh
  when: not runner_config.stat.exists

- name: Show runner ready message
  ansible.builtin.debug:
    msg: >
      Runner binary installed at /data/actions-runner.
      Run scripts/setup-runner.sh with a GitHub PAT to register.
