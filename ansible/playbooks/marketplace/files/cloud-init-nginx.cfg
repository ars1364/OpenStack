#cloud-config
# Cloud-init user-data for Nginx marketplace image
# Customize: domain, backend_port, email for SSL

package_update: false
package_upgrade: false

write_files:
  - path: /etc/nginx/sites-available/myapp.conf
    content: |
      server {
          listen 80;
          server_name ${DOMAIN:=example.com};

          location / {
              proxy_pass http://127.0.0.1:${BACKEND_PORT:=3000};
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_cache_bypass $http_upgrade;
              proxy_read_timeout 300;
              proxy_connect_timeout 300;
          }

          location /health {
              access_log off;
              return 200 'OK';
              add_header Content-Type text/plain;
          }
      }

runcmd:
  # Enable the site
  - ln -sf /etc/nginx/sites-available/myapp.conf /etc/nginx/sites-enabled/myapp.conf
  - rm -f /etc/nginx/sites-enabled/default
  - nginx -t && systemctl reload nginx
  # Uncomment below for automatic SSL (requires valid domain pointing to this server)
  # - certbot --nginx --non-interactive --agree-tos -m admin@example.com -d example.com
  - echo "Nginx marketplace image ready" > /var/log/cloud-init-nginx.log
